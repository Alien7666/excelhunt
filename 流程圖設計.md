# ExcelHunt 流程圖設計

## 系統主要流程圖

以下是 ExcelHunt 系統的主要流程設計，描述了從用戶交互到資料處理的完整流程。

## 1. 整體系統架構流程

```
+---------------------------+           +----------------------------+
|                           |           |                            |
|  使用者介面 (Frontend)    |<--------->|  後端服務 (Backend)        |
|                           |   HTTP    |                            |
+---------------------------+           +----------------------------+
            ^                                       ^
            |                                       |
            |  網頁請求                              | 資料請求
            |                                       |
            v                                       v
+---------------------------+           +----------------------------+
|                           |           |                            |
|   Web 伺服器 (Tomcat)     |<--------->|    MongoDB 資料庫          |
|                           |           |                            |
+---------------------------+           +----------------------------+
```

## 2. 使用者搜尋流程

```
+-------------+    搜尋請求    +----------------+    解析請求    +-------------------+
|             |-------------->|                |--------------->|                   |
| 使用者界面   |               |SearchController|                | SearchService(s)  |
|             |<--------------|                |<---------------|                   |
+-------------+    回傳結果    +----------------+    處理結果    +-------------------+
                                                                   |
                                                                   | 查詢資料
                                                                   v
                                                 +-------------------+
                                                 |                   |
                                                 |  MongoDB 集合     |
                                                 |                   |
                                                 +-------------------+
```

### 詳細流程步驟:
1. 使用者在前端輸入搜尋關鍵字並提交
2. 請求發送到 SearchController
3. SearchController 呼叫 SearchServicemuticore 的 multiCollectionSearch 方法
4. SearchServicemuticore 並行搜尋多個 MongoDB 集合
5. 將搜尋結果整合並格式化
6. 結果返回給 SearchController
7. SearchController 將結果添加到模型中
8. 使用 Thymeleaf 模板引擎渲染結果頁面
9. 最終頁面返回給使用者

## 3. 用戶登入流程

```
+-------------+    登入請求    +----------------+    驗證請求    +----------------------+
|             |-------------->|                |--------------->|                      |
| 登入頁面     |               |LoginController |                | Spring Security      |
|             |<--------------|                |<---------------|                      |
+-------------+    回傳結果    +----------------+    認證結果    +----------------------+
                                                                   |
                                                                   | 使用者查詢
                                                                   v
                                                 +-------------------+
                                                 |                   |
                                                 | UserDetailsService|
                                                 |                   |
                                                 +-------------------+
                                                         |
                                                         | 資料庫查詢
                                                         v
                                                 +-------------------+
                                                 |                   |
                                                 | MongoDB (user集合)|
                                                 |                   |
                                                 +-------------------+
```

### 詳細流程步驟:
1. 使用者訪問登入頁面並提交憑證
2. 請求發送到 Spring Security 的驗證過濾器
3. 過濾器將請求傳遞給 CustomUserDetailsService
4. CustomUserDetailsService 從 MongoDB 查詢使用者資訊
5. 驗證使用者輸入的密碼與資料庫中的加密密碼
6. 根據驗證結果創建驗證令牌或拒絕訪問
7. 如果驗證成功，重定向到控制面板頁面
8. 如果驗證失敗，重定向回登入頁面並顯示錯誤訊息

## 4. 資料存取流程

```
+-----------------+    請求資料    +------------------+    資料操作    +------------------+
|                 |--------------->|                  |--------------->|                  |
| 服務層 (Service) |                | 資料訪問層        |                | MongoDB          |
|                 |<---------------|                  |<---------------|                  |
+-----------------+    返回資料    +------------------+    資料結果    +------------------+
```

### 詳細流程步驟:
1. 服務層需要讀取或寫入資料
2. 呼叫對應的 Repository 方法
3. Repository 將請求轉換為 MongoDB 查詢
4. 執行查詢並獲取結果
5. 將資料結果返回給服務層
6. 服務層處理或轉換資料
7. 返回處理後的資料給控制器

## 5. 密碼變更流程

```
+-------------+    變更請求    +-------------------+    驗證請求    +-------------------+
|             |-------------->|                   |--------------->|                   |
| 設定頁面     |               | PasswordController |               | SecurityService   |
|             |<--------------|                   |<---------------|                   |
+-------------+    回傳結果    +-------------------+    驗證結果    +-------------------+
                                       |
                                       | 密碼更新
                                       v
                            +----------------------+
                            |                      |
                            | UserRepository       |
                            |                      |
                            +----------------------+
                                       |
                                       | 資料存儲
                                       v
                            +----------------------+
                            |                      |
                            | MongoDB (user集合)   |
                            |                      |
                            +----------------------+
```

### 詳細流程步驟:
1. 使用者訪問密碼變更頁面並提交新密碼
2. 請求發送到 PasswordController
3. 控制器驗證當前使用者身份
4. 驗證舊密碼是否正確
5. 使用 BCryptPasswordEncoder 對新密碼進行加密
6. 更新資料庫中的密碼記錄
7. 返回成功訊息或錯誤訊息給使用者

## 6. 檔案上傳流程 (Google Cloud Storage)

```
+-------------+    上傳請求    +-------------------+    存儲請求    +-------------------+
|             |-------------->|                   |--------------->|                   |
| 管理介面     |               | 上傳控制器         |               | Cloud Storage API |
|             |<--------------|                   |<---------------|                   |
+-------------+    回傳結果    +-------------------+    存儲結果    +-------------------+
                                                                    |
                                                                    | 檔案存儲
                                                                    v
                                                      +------------------------+
                                                      |                        |
                                                      | Google Cloud Storage   |
                                                      |                        |
                                                      +------------------------+
```

### 詳細流程步驟:
1. 使用者從管理介面選擇檔案並上傳
2. 上傳請求發送到對應的控制器
3. 控制器驗證檔案格式和大小
4. 使用 Google Cloud Storage API 上傳檔案
5. 獲取檔案的公開URL或識別符
6. 將檔案資訊儲存到資料庫
7. 返回上傳結果給使用者

## 7. 系統錯誤處理流程

```
+-------------+    請求     +-------------------+    發生錯誤    +-------------------+
|             |------------>|                   |--------------->|                   |
| 使用者介面   |             | 系統控制器         |               | 錯誤處理器        |
|             |<------------|                   |<---------------|                   |
+-------------+    錯誤頁面  +-------------------+    錯誤資訊    +-------------------+
                                                                   |
                                                                   | 記錄錯誤
                                                                   v
                                                     +-------------------+
                                                     |                   |
                                                     | 日誌系統          |
                                                     |                   |
                                                     +-------------------+
```

### 詳細流程步驟:
1. 系統處理請求過程中發生異常
2. Spring Boot 的錯誤處理機制捕獲異常
3. 異常傳遞給自定義錯誤處理器 (MyErrorController)
4. 錯誤處理器記錄錯誤詳情
5. 根據錯誤類型選擇適當的錯誤頁面
6. 將使用者重定向到錯誤頁面
7. 顯示友好的錯誤訊息給使用者

---

## 系統數據流程圖

下面的數據流程圖展示了系統中主要數據如何在不同組件之間流動。

```
[使用者] -----> [輸入搜尋條件] -----> [SearchController]
                                       |
                                       v
[顯示結果] <---- [渲染模板] <----- [SearchService]
                                       |
                                       v
                                  [MongoDB查詢]
                                       |
                                       v
                               [MongoDB集合: 儲位資料, 
                                月庫存, 毛量, 產品資料]
```

## 設計要點

1. **分離關注點**: 各組件職責明確，控制器處理請求路由，服務處理業務邏輯，資料訪問層處理資料操作。

2. **並行處理**: 搜尋服務使用多執行緒來提高效能，允許同時搜尋多個集合。

3. **安全性**: 所有使用者輸入在處理前都經過驗證和清理，防止注入攻擊。

4. **錯誤處理**: 系統設計了統一的錯誤處理機制，確保即使發生異常也能提供良好的使用者體驗。

5. **可擴展性**: 系統採用模組化設計，便於添加新功能或修改現有功能。
